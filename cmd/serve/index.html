<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="/static/assets/img/favicons/icon_logo.svg" />
  <link rel="stylesheet" href="/static/assets/css/uswds.css" media="all" type="text/css">
</head>

<body>
  <a class="usa-skipnav" href="#main-content">Skip to main content</a>
  <div class="usa-overlay"></div>
  <div class="usa-section">
    <div class="grid-container">
      <div class="grid-row grid-gap">
        <div class="usa-layout-docs__sidenav display-none desktop:display-block desktop:grid-col-3">
          <nav aria-label="Secondary navigation">
            <ul class="usa-sidenav" id="database-list">
              <li class="usa-sidenav__item">
                <a href="javascript:void(0);">Parent link</a>
              </li>
            </ul>
            
            </nav>
            <p class="margin-left-1" id="elapsed-time">
            </p>
        </div>
        <main class="desktop:grid-col-9 usa-prose" id="main-content">
          <h1>Search some things</h1>
          <p class="usa-intro">
            This is a search engine in 2500 lines of code.
          </p>

          <section aria-label="Big search component">
            <label class="usa-sr-only" for="search-field-en-big">Search</label>
            <input class="usa-input" id="six-search" type="six-search" name="six-search" />
            <br />
            <button class="usa-button" id="six-button">
              <span class="usa-search__submit-text">Search</span>
            </button>
            <ol id="six-list"></ol>
          </section>
        </main>
      </div>


      <script>


        function DoTheSearch() {
          // https://stackoverflow.com/questions/24468459/sending-a-json-to-server-and-retrieving-a-json-in-return-without-jquery
          // Sending and receiving data in JSON format using POST method
          // http POST http://localhost:10004/search/cloud.gov terms="python cloud foundry developers"

          // let site = document.getElementById("six-site");
          site_url = "{HOST}"
          console.log(site_url);
          // https://stackoverflow.com/questions/11563638/how-do-i-get-the-value-of-text-input-field-using-javascript

          var post_url = "{SCHEME}://localhost:{PORT}/serve"
          console.log(post_url);

          var query = document.getElementById('six-search').value
          console.log(query);

          const data = { "terms": query, "host": "{SEARCH_HOST}" }

          fetch(post_url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          })
            .then(response => {

              if (!response.ok) {
                throw new Error('Network response was not ok');
              }

              return response.json();
            })
            .then(userData => {
              // Process the retrieved user data
              console.log('User Data:', userData);
              document.getElementById("six-list").innerHTML = "";

              var list = document.getElementById('six-list');
              console.log(list);

              time = userData.elapsed;
              time = Math.round(time / 100000)
              time = time / 10;
              console.log(time)
              timing_e = document.getElementById("elapsed-time")
              timing_e.innerHTML = "Query time: " + time + " &mu;s"

              for (var k in userData.results) {
                var r = userData.results[k];
                if (r.path.length > 0) {
                // console.log(k, userData.results[k]);
                console.log(r)
                console.log(r.snippet)
                var entry = document.createElement('li');
                var h = "<a href='https://{HOST}" + r.path + "' target='_blank'>" + r.path + "</a>"
                h += "<br/>" + r.snippet
                entry.innerHTML = h
                list.appendChild(entry);

                }
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
        };

        function HandleTheKeyboardClicks() {
          var key = window.event.keyCode;
          // If the user has pressed enter
          if ((key === 13) || (key === 32)) {
            DoTheSearch();
          }
          return true;
        }


        function GetDatabases() {
          var post_url = "{SCHEME}://{HOST}:{PORT}/databases"
          fetch(post_url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          })
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(responseData => {
              console.log('Response Data:', responseData);
              document.getElementById("database-list").innerHTML = "";
              var list = document.getElementById('database-list');
              for (var k in responseData.databases) {
                var db = responseData.databases[k];
                var entry = document.createElement('li');
                entry.classList.add("usa-sidenav__item")
                if ("{HOST}" === db) {
                  entry.classList.add("usa-current");
                }
                var link = document.createElement('a')
                link.innerHTML = db
                link.setAttribute("href", "{SCHEME}://{HOST}:{PORT}/search/" + db)
                entry.appendChild(link)
                list.appendChild(entry);
                console.log(entry);
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
        };


        function DoAllTheThings() {
          GetDatabases();
        }


        document.getElementById("six-search").onkeypress = HandleTheKeyboardClicks;
        document.getElementById("six-button").onclick = DoTheSearch;
        window.onload = DoAllTheThings;


      </script>

    </div>
  </div>
  <div class="usa-identifier">
    <section class="usa-identifier__section usa-identifier__section--usagov"
      aria-label="U.S. government information and services">
      <div class="usa-identifier__container">
        <div class="usa-identifier__usagov-description">
          Looking for U.S. government information and services?
        </div>
        <a href="https://www.usa.gov/" class="usa-link">Visit USA.gov</a>
      </div>
    </section>
  </div>
</body>

</html>