<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="/static/assets/img/favicons/icon_logo.svg" />
  <link rel="stylesheet" href="/static/assets/css/uswds.css" media="all" type="text/css">
</head>

<body>
  <a class="usa-skipnav" href="#main-content">Skip to main content</a>
  <div class="usa-overlay"></div>
  <div class="usa-section">
    <div class="grid-container">
      <div class="grid-row grid-gap">
        <div class="usa-layout-docs__sidenav display-none desktop:display-block desktop:grid-col-3">
          <nav aria-label="Secondary navigation">
            <ul class="usa-sidenav" id="database-list">
              <li class="usa-sidenav__item">
                <a href="javascript:void(0);">Parent link</a>
              </li>
            </ul>

          </nav>
          <div id="stats"></div>
        </div>
        <main class="desktop:grid-col-9 usa-prose" id="main-content">
          <h1>Search some things</h1>
          <p class="usa-intro">
            This is a search engine in under 3000 lines of code.
          </p>

          <section aria-label="Big search component">
            <label class="usa-sr-only" for="search-field-en-big">Search</label>
            <input class="usa-input" id="six-search" type="six-search" name="six-search" />
            <br />
            <button class="usa-button" id="six-button">
              <span class="usa-search__submit-text">Search</span>
            </button>
            <ol id="six-list"></ol>
          </section>
        </main>
      </div>


      <script>


        function DoTheSearch() {
          site_url = "{HOST}"
          console.log(site_url);
          var post_url = "{SCHEME}://{HOST}:{PORT}/serve"
          console.log(post_url);
          var query = document.getElementById('six-search').value
          console.log(query);

          const data = { "terms": query, "host": "{SEARCH_HOST}" }

          fetch(post_url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          })
            .then(response => {

              if (!response.ok) {
                throw new Error('Network response was not ok');
              }

              return response.json();
            })
            .then(userData => {
              // Process the retrieved user data
              document.getElementById("six-list").innerHTML = "";

              var list = document.getElementById('six-list');
              console.log(list);

              var stats = document.getElementById('stats')
              stats.innerHTML = "";
              query_time = userData.elapsed;
              statPara(stats, "Query time", nanoToMillis(query_time), "ms")
              AllTheStats(stats)

              for (var k in userData.results) {
                var r = userData.results[k];
                if (r.path.length > 0) {
                  var entry = document.createElement('li');
                  var h = "<a href='https://{HOST}" + r.path + "' target='_blank'>" + r.path + "</a>"
                  h += "<br/>" + r.snippet
                  entry.innerHTML = h
                  list.appendChild(entry);

                }
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
        };

        function statPara(stats, tag, value, units) {
          var elapsedp = document.createElement('p')
          elapsedp.classList.add("margin-left-1")
          elapsedp.innerHTML = tag + ": " + value + " " + units
          stats.appendChild(elapsedp)
        }

        function nanoToMillis(v) {
          v = Math.round(v / 100000)
          v = v / 10
          return v
        }

        function AllTheStats(stats) {
          site_url = "{HOST}"
          var get_url = "{SCHEME}://{HOST}:{PORT}/stats"
          fetch(get_url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            }
          })
            .then(response => {

              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(userData => {
              data = userData["stats"]
              statPara(stats, "Avg. query time", nanoToMillis(data["_average_query_time"]), "ms")
              statPara(stats, "Queries", data["_{SEARCH_HOST}"], "")

              top_queries = []
              console.log("DATA", data)
              for (const key in data) {
                v = data[key]
                if (key.startsWith("_")) {
                  // skip
                } else {
                  top_queries.push(key)
                }
              }

              if (top_queries != []) {
                e = document.createElement('p')
                b = document.createElement('b')
                b.innerHTML = "Top queries"
                e.appendChild(b)
                stats.appendChild(e)

                sorted = top_queries.sort().reverse().slice(0, 3)
                for (const key of sorted) {
                  statPara(stats, key, data[key], "")
                }
              }


            })
        }


        function HandleTheKeyboardClicks() {
          var key = window.event.keyCode;
          // If the user has pressed enter
          if ((key === 13) || (key === 32)) {
            DoTheSearch();
          }
          return true;
        }


        function GetDatabases() {
          var post_url = "{SCHEME}://{HOST}:{PORT}/databases"
          fetch(post_url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          })
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(responseData => {
              console.log('Response Data:', responseData);
              document.getElementById("database-list").innerHTML = "";
              var list = document.getElementById('database-list');
              for (var k in responseData.databases) {
                var db = responseData.databases[k];
                var entry = document.createElement('li');
                entry.classList.add("usa-sidenav__item")
                if ("{HOST}" === db) {
                  entry.classList.add("usa-current");
                }
                var link = document.createElement('a')
                link.innerHTML = db
                link.setAttribute("href", "{SCHEME}://{HOST}:{PORT}/search/" + db)
                entry.appendChild(link)
                list.appendChild(entry);
                console.log(entry);
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
        };


        function DoAllTheThings() {
          GetDatabases();
        }


        document.getElementById("six-search").onkeypress = HandleTheKeyboardClicks;
        document.getElementById("six-button").onclick = DoTheSearch;
        window.onload = DoAllTheThings;


      </script>

    </div>
  </div>
  <div class="usa-identifier">
    <section class="usa-identifier__section usa-identifier__section--usagov"
      aria-label="U.S. government information and services">
      <div class="usa-identifier__container">
        <div class="usa-identifier__usagov-description">
          Looking for U.S. government information and services?
        </div>
        <a href="https://www.usa.gov/" class="usa-link">Visit USA.gov</a>
      </div>
    </section>
  </div>
</body>

</html>